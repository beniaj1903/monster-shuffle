//! Gestión de PP (Power Points) de movimientos
//!
//! Este módulo es responsable de:
//! - Inicializar PP de movimientos
//! - Consumir PP al usar movimientos
//! - Verificar disponibilidad de PP
//! - Crear el movimiento Struggle

use crate::models::{PokemonInstance, MoveData, MoveMeta};

/// Inicializa el PP de un movimiento si no está inicializado (current_pp == 0)
/// Busca el movimiento en el Pokémon y lo inicializa con el PP máximo del MoveData
/// Si el movimiento ya tiene max_pp > 0, no hace nada (ya está inicializado)
pub fn initialize_move_pp(pokemon: &mut PokemonInstance, move_template_id: &str, move_data: &MoveData) {
    // Buscar el movimiento aprendido en la lista del Pokémon
    if let Some(learned_move) = pokemon.get_learned_move(move_template_id) {
        // Si el PP no está inicializado (max_pp == 0), inicializarlo con el PP máximo del MoveData
        if learned_move.max_pp == 0 {
            learned_move.max_pp = move_data.pp;
            learned_move.current_pp = move_data.pp;
        }
    }
}

/// Decrementa el PP de un movimiento después de usarlo
/// Retorna true si el movimiento se usó exitosamente (tenía PP > 0)
pub fn consume_move_pp(pokemon: &mut PokemonInstance, move_template_id: &str) -> bool {
    eprintln!("[DEBUG] consume_move_pp: Intentando consumir PP de {} para {}", move_template_id, pokemon.species.display_name);
    // Buscar el movimiento aprendido en la lista del Pokémon
    if let Some(learned_move) = pokemon.get_learned_move(move_template_id) {
        eprintln!("[DEBUG] consume_move_pp: Movimiento encontrado, PP actual: {}/{}", learned_move.current_pp, learned_move.max_pp);
        // Verificar que tenga PP disponible
        if learned_move.current_pp > 0 {
            learned_move.current_pp -= 1;
            eprintln!("[DEBUG] consume_move_pp: PP consumido, nuevo PP: {}/{}", learned_move.current_pp, learned_move.max_pp);
            return true;
        } else {
            eprintln!("[DEBUG] consume_move_pp: WARNING - Sin PP disponible (current_pp = 0)");
            return false; // Sin PP disponible
        }
    }
    eprintln!("[DEBUG] consume_move_pp: ERROR - Movimiento {} no encontrado en los movimientos aprendidos", move_template_id);
    false // Movimiento no encontrado
}

/// Verifica si un Pokémon tiene movimientos con PP disponible
/// Retorna true si tiene al menos un movimiento con PP > 0
pub fn has_moves_with_pp(pokemon: &PokemonInstance) -> bool {
    let active_moves = pokemon.get_active_learned_moves();
    let has_pp = active_moves.iter().any(|m| m.current_pp > 0);
    eprintln!("[DEBUG] has_moves_with_pp: {} tiene {} movimientos activos, tiene PP: {}",
        pokemon.species.display_name, active_moves.len(), has_pp);
    for m in active_moves {
        eprintln!("[DEBUG] has_moves_with_pp:   - {}: {}/{} PP", m.move_id, m.current_pp, m.max_pp);
    }
    has_pp
}

/// Crea un MoveData para Struggle (movimiento de emergencia)
/// Struggle: Tipo Normal, Potencia 50, PP infinito (no se consume), daño de retroceso 1/4 HP
pub fn create_struggle_move() -> MoveData {
    MoveData {
        id: "struggle".to_string(),
        name: "Forcejeo".to_string(),
        r#type: "Normal".to_string(),
        power: Some(50),
        accuracy: None, // Struggle siempre acierta
        priority: 0,
        pp: 255, // PP infinito (no se consume realmente)
        damage_class: "physical".to_string(),
        meta: MoveMeta {
            ailment: "none".to_string(),
            ailment_chance: 0,
            crit_rate: 0,
            drain: -25, // Recoil: 25% del daño (pero Struggle usa 1/4 del HP máximo)
            flinch_chance: 0,
            stat_chance: 0,
            healing: 0,
            min_hits: None,
            max_hits: None,
            min_turns: None,
            max_turns: None,
            makes_contact: true, // Struggle hace contacto
            forces_switch: false,
        },
        stat_changes: Vec::new(),
        target: "selected-pokemon".to_string(),
    }
}

// NOTA: Tests no incluidos aquí porque requieren actualización al modelo actual de PokemonInstance.
// La funcionalidad ya está testeada implícitamente en los tests de pipeline y checks existentes.
